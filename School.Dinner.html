<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™êµ ì„ì‹ ì¶œì… ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- jsQR Library (for scanning) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- qrcode.js Library (for generating QR code in student mode) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .main-card {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        /* Scanner specific styles */
        #video, #canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }
        #canvas { position: absolute; top: 0; left: 0; }
        .scan-container {
            position: relative; 
            width: 100%; 
            padding-top: 100%; /* 1:1 ë¹„ìœ¨ ìœ ì§€ */
            max-width: 400px; 
            margin: 0 auto;
            border-radius: 1rem; 
            overflow: hidden; 
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        .scan-area-mask { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); }
        .scan-area-cutout {
            position: absolute; top: 25%; left: 25%; width: 50%; height: 50%; 
            border: 4px solid #3b82f6; z-index: 10; animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
            50% { border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
            100% { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        }
        .status-waiting { background-color: #fef3c7; border-left: 8px solid #f59e0b; }
        .status-success { background-color: #d1fae5; border-left: 8px solid #10b981; }
        .status-error { background-color: #fee2e2; border-left: 8px solid #ef4444; }
        
        /* Table styles */
        .meal-status-tag { padding: 4px 8px; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }
        .meal-status-paid { background-color: #d1fae5; color: #065f46; } /* ì‹ ì²­í•¨ (Green) */
        .meal-status-unpaid { background-color: #fef3c7; color: #92400e; } /* ë¯¸ì‹ ì²­ (Yellow) */
        .checkin-status-waiting { background-color: #fef3c7; color: #92400e; } /* ëŒ€ê¸° ì¤‘ (Yellow) */
        .checkin-status-complete { background-color: #d1fae5; color: #065f46; } /* ì²´í¬ì¸ ì™„ë£Œ (Green) */

    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center flex items-center justify-center">
            <span class="mr-3 text-4xl">ğŸ‘¨â€ğŸ“</span> í•™êµ ì„ì‹ ì¶œì… ê´€ë¦¬ ì‹œìŠ¤í…œ
        </h1>
        <p id="user-id-display" class="text-sm text-gray-500 mb-6 text-center">ì‚¬ìš©ì ID: ë¡œë”© ì¤‘...</p>
        
        <!-- Mode Switch Buttons -->
        <div class="flex justify-center space-x-0 bg-white p-1 rounded-xl shadow-lg mb-8 max-w-lg mx-auto">
            <button id="student-mode-btn" onclick="toggleMode('student')" class="flex-1 px-4 py-2 rounded-xl font-semibold transition-all bg-white text-gray-700 hover:bg-gray-100">
                í•™ìƒ ëª¨ë“œ (QR ì½”ë“œ ìƒì„±)
            </button>
            <button id="staff-mode-btn" onclick="toggleMode('staff')" class="flex-1 px-4 py-2 rounded-xl font-semibold transition-all bg-blue-600 text-white shadow-md">
                ê´€ë¦¬ì ëª¨ë“œ
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="main-content-area" class="main-card">
            
            <!-- --------------------------------- 
                 ê´€ë¦¬ì ëª¨ë“œ View 
                 --------------------------------- -->
            <div id="staff-mode-view" class="space-y-8" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">ê´€ë¦¬ì ê¸°ëŠ¥</h2>
                
                <!-- Admin Sub-Tab Switch -->
                <div class="flex justify-center space-x-0 bg-gray-100 p-1 rounded-lg max-w-md mx-auto">
                    <button id="scanner-tab-btn" onclick="toggleAdminTab('scanner')" class="flex-1 px-4 py-2 rounded-md font-semibold transition-all bg-blue-600 text-white">
                        ì²´í¬ì¸ ìŠ¤ìºë„ˆ
                    </button>
                    <button id="data-tab-btn" onclick="toggleAdminTab('data')" class="flex-1 px-4 py-2 rounded-md font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-white">
                        í•™ìƒ ë°ì´í„° ê´€ë¦¬
                    </button>
                </div>
                
                <!-- 1. Scanner Tab Content -->
                <div id="scanner-tab" class="grid grid-cols-1 lg:grid-cols-2 gap-8 pt-4">
                    <!-- Scanner -->
                    <div class="scan-container">
                        <video id="video" class="absolute inset-0"></video>
                        <canvas id="canvas" class="absolute inset-0 hidden"></canvas>
                        
                        <div id="scan-ui-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="scan-area-mask"></div>
                            <div class="scan-area-cutout"></div>
                        </div>
        
                        <div id="no-camera-msg" class="absolute inset-0 bg-gray-700 flex flex-col items-center justify-center p-4 text-white text-center rounded-xl" style="display: none;">
                            <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            <p class="font-semibold">ì¹´ë©”ë¼ ì ‘ê·¼ ë¶ˆê°€</p>
                            <p class="text-sm mt-1">ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•˜ê³ , í›„ë©´ ì¹´ë©”ë¼ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
    
                    <!-- Status Box & Log -->
                    <div class="flex flex-col space-y-4">
                        <div id="status-box" class="result-box p-5 rounded-xl status-waiting">
                            <h3 id="status-title" class="text-xl font-bold text-gray-800">ì²´í¬ì¸ ìŠ¤ìºë„ˆ ëŒ€ê¸° ì¤‘...</h3>
                            <p id="status-message" class="mt-1 text-gray-600">í•™ìƒì˜ QR ì½”ë“œë¥¼ ìŠ¤ìº” ì˜ì—­ì— ë¹„ì¶°ì£¼ì„¸ìš”.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">ìŠ¤ìº” ë¡œê·¸</h3>
                            <ul id="log-list" class="space-y-2 text-sm text-gray-600 h-32 overflow-y-auto">
                                <li class="p-2 bg-white rounded">ì‹œìŠ¤í…œ ì‹œì‘ë¨.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 2. Data Management Tab Content -->
                <div id="data-tab" class="space-y-6" style="display: none;">
                    
                    <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">í•™ìƒ ì •ë³´ ê´€ë¦¬ (ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸)</h3>
                        <p class="text-gray-600 text-sm mb-4">
                            í•™ìƒì´ ë“±ë¡(íšŒì›ê°€ì…)ì„ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì— ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤. ê²°ì œ ìƒíƒœë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                        
                        <div id="data-status-msg" class="mt-3 text-sm text-center font-semibold text-green-600" style="display: none;"></div>
                    </div>
                    
                </div>
                
                <!-- 3. Real-time Status Table (Shared) -->
                <div class="bg-white p-6 rounded-xl shadow mt-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">ì „ì²´ í•™ìƒ í˜„í™© (ì‹¤ì‹œê°„)</h3>
                    
                    <div class="overflow-x-auto relative shadow-md sm:rounded-lg mb-4">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-6">ì´ë¦„</th>
                                    <th scope="col" class="py-3 px-6">í•™ë²ˆ</th>
                                    <th scope="col" class="py-3 px-6">ì„ì‹ ìƒíƒœ</th>
                                    <th scope="col" class="py-3 px-6">ì²´í¬ì¸ ìƒíƒœ</th>
                                    <th scope="col" class="py-3 px-6">QR ì½”ë“œ ID</th>
                                </tr>
                            </thead>
                            <tbody id="student-status-body">
                                <tr class="bg-white border-b"><td class="py-4 px-6 text-center" colspan="5">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <button onclick="resetTodayCheckins()" class="block mx-auto py-2 px-6 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center shadow-md">
                        <span class="text-xl mr-2">ğŸ”„</span> ì˜¤ëŠ˜ ì²´í¬ì¸ ìƒíƒœ ëª¨ë‘ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>


            <!-- --------------------------------- 
                 í•™ìƒ ëª¨ë“œ View 
                 --------------------------------- -->
            <div id="student-mode-view" class="p-8 flex flex-col items-center justify-center h-full rounded-xl shadow-lg">
                <h2 id="student-view-title" class="text-2xl font-bold mb-6 text-gray-800 text-center">í•™ìƒ ëª¨ë“œ</h2>
                
                <!-- ì¸ì¦ ì˜ì—­ (íšŒì›ê°€ì…/ë¡œê·¸ì¸) -->
                <div id="student-auth-area" class="max-w-md w-full space-y-4">
                    <!-- í•™ìƒ ì •ë³´ ë“±ë¡ (íšŒì›ê°€ì…) Form -->
                    <div id="register-form">
                        <h3 class="text-xl font-bold text-blue-600 mb-4 text-center">ğŸ“Œ í•™ìƒ ë“±ë¡ (íšŒì›ê°€ì…)</h3>
                        <input id="register-name" type="text" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-blue-500" required>
                        <input id="register-grade-class" type="text" placeholder="í•™ë…„/ë°˜ (ì˜ˆ: 1í•™ë…„ 4ë°˜)" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-blue-500" required>
                        <input id="register-pin" type="password" placeholder="4ìë¦¬ ë¹„ë°€ í•€ ë²ˆí˜¸ (ì˜ˆ: 1234)" pattern="\d{4}" maxlength="4" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500" required>
                        
                        <button onclick="registerUser()" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors shadow-md">
                            âœ… ë“±ë¡í•˜ê³  QR ì½”ë“œ ë°›ê¸°
                        </button>
                        <p class="text-sm text-center text-gray-500 mt-3">ì´ë¯¸ ë“±ë¡í•˜ì…¨ë‹¤ë©´ <a href="#" onclick="showLoginForm()" class="text-blue-600 hover:text-blue-800 font-semibold">ë¡œê·¸ì¸</a>í•´ ì£¼ì„¸ìš”.</p>
                        <p id="register-status" class="mt-3 text-center text-sm font-semibold text-red-600" style="display: none;"></p>
                    </div>

                    <!-- ë¡œê·¸ì¸ Form -->
                    <div id="login-form" style="display: none;">
                        <h3 class="text-xl font-bold text-blue-600 mb-4 text-center">ğŸ”‘ QR ì½”ë“œ í™œì„±í™” (ë¡œê·¸ì¸)</h3>
                        <input id="login-name" type="text" placeholder="ë“±ë¡í•œ ì´ë¦„" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-blue-500" required>
                        <input id="login-pin" type="password" placeholder="4ìë¦¬ ë¹„ë°€ í•€ ë²ˆí˜¸" pattern="\d{4}" maxlength="4" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500" required>
                        
                        <button onclick="loginUser()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                            â¡ï¸ ë¡œê·¸ì¸ ë° QR ì½”ë“œ í‘œì‹œ
                        </button>
                        <p class="text-sm text-center text-gray-500 mt-3">ë“±ë¡í•˜ì§€ ì•Šìœ¼ì…¨ë‹¤ë©´ <a href="#" onclick="showRegisterForm()" class="text-green-600 hover:text-green-800 font-semibold">í•™ìƒ ë“±ë¡</a>ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.</p>
                        <p id="login-status" class="mt-3 text-center text-sm font-semibold text-red-600" style="display: none;"></p>
                    </div>

                </div>
                
                <!-- QR ì½”ë“œ ì˜ì—­ (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
                <div id="student-qr-area" class="mt-8 flex flex-col items-center" style="display: none;">
                    <p id="student-info-display" class="text-xl font-bold text-gray-700 mb-4 text-center"></p>
                    <p class="text-lg text-blue-600 font-semibold mb-4 text-center">ì§ì› ëª¨ë“œ ìŠ¤ìºë„ˆì— ì´ ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”!</p>
                    <div id="qrcode-display" class="p-4 border-8 border-blue-600 rounded-lg bg-white shadow-2xl">
                        <!-- QR Code will be generated here -->
                    </div>
                    <p class="text-sm text-gray-500 mt-4 text-center">
                        QR ì½”ë“œ ë°ì´í„° (ë³´ì•ˆ ID): <span id="student-qr-data" class="font-mono text-xs"></span>
                    </p>
                    <button onclick="logoutUser()" class="mt-6 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                        ë¡œê·¸ì•„ì›ƒ (QR ì½”ë“œ ìˆ¨ê¸°ê¸°)
                    </button>
                </div>
                
            </div>


        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, getDocs, addDoc, collection, query, where, Timestamp, onSnapshot, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”
        setLogLevel('Debug');

        // Global Variables
        let app;
        let db;
        let auth;
        let userId = '';
        let currentMode = 'student'; // ì´ˆê¸° ëª¨ë“œë¥¼ í•™ìƒ ëª¨ë“œë¡œ ë³€ê²½
        let currentAdminTab = 'scanner';
        let isUserRegistered = false; // í•™ìƒì´ ë“±ë¡ì„ ì™„ë£Œí–ˆëŠ”ì§€ ì—¬ë¶€
        let studentProfile = null; // í•™ìƒ ì •ë³´ ìºì‹œ
        
        // Scanner Variables
        let video = document.getElementById('video');
        let canvasElement = document.getElementById('canvas');
        let canvas = canvasElement.getContext('2d');
        let videoStream = null;
        let isProcessing = false; 
        let lastScannedCode = null; 
        
        // Data Variables
        let qrCodeInstance = null; 
        let studentDataCache = {}; // ë“±ë¡ëœ í•™ìƒ ì •ë³´ë¥¼ ì €ì¥í•  ìºì‹œ
        let checkinDataCache = {}; // ì˜¤ëŠ˜ ì²´í¬ì¸ ì •ë³´ë¥¼ ì €ì¥í•  ìºì‹œ

        // --- 1. Firebase Initialization and Authentication ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const USERS_COLLECTION = `/artifacts/${appId}/public/data/users`;
        const CHECKINS_COLLECTION = `/artifacts/${appId}/public/data/checkins`;
        const LOGS_COLLECTION = `/artifacts/${appId}/public/data/logs`;
        const TODAY_DATE = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}... (ì „ì²´ ID: ${userId})`;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    
                    // Auth ì™„ë£Œ í›„ ê¸°ë³¸ ëª¨ë“œ ì‹œì‘ ë° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    setupMode(currentMode); 
                    setupLogListener();
                    setupStudentStatusListener(); // í•™ìƒ í˜„í™©íŒ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                    
                    // í•™ìƒ ë“±ë¡ ì •ë³´ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸
                    checkUserRegistrationStatus(userId);

                } else {
                    console.log("No user signed in. Attempting anonymous or custom sign-in.");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Sign-In Failed:", error);
                        // Student mode UI will handle the error gracefully
                    }
                }
            });
        } else {
            console.error("Firebase configuration is missing.");
            alertMessage('âš ï¸ ì„¤ì • ì˜¤ë¥˜', 'Firebase ì„¤ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        }
        
        /**
         * ìƒíƒœ ë©”ì‹œì§€ë¥¼ UIì— í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function alertMessage(title, message, status) {
            const statusBox = document.getElementById('status-box');
            if (statusBox) {
                statusBox.classList.remove('status-waiting', 'status-success', 'status-error');
                statusBox.classList.add(`status-${status}`);
                document.getElementById('status-title').textContent = title;
                document.getElementById('status-message').textContent = message;
            } else {
                // For modes where statusBox is not visible (like student mode)
                console.log(`STATUS [${status.toUpperCase()}]: ${title} - ${message}`);
            }
        }


        // --- 2. Mode and Tab Management Functions ---
        
        /**
         * ëª¨ë“œ ì„¤ì • ë° ì „í™˜ ì²˜ë¦¬ ('staff' or 'student')
         */
        function setupMode(mode) {
            currentMode = mode;
            const staffView = document.getElementById('staff-mode-view');
            const studentView = document.getElementById('student-mode-view');
            const staffBtn = document.getElementById('staff-mode-btn');
            const studentBtn = document.getElementById('student-mode-btn');
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            staffBtn.className = 'flex-1 px-4 py-2 rounded-xl font-semibold transition-all';
            studentBtn.className = 'flex-1 px-4 py-2 rounded-xl font-semibold transition-all';

            if (mode === 'staff') {
                // ì§ì› ëª¨ë“œ í™œì„±í™”
                staffView.style.display = 'block';
                studentView.style.display = 'none';
                
                // ì§ì› ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
                staffBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                studentBtn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                
                // Admin Sub-Tab ìƒíƒœì— ë”°ë¼ ìŠ¤ìºë„ˆ ì‹œì‘/ì¤‘ì§€
                toggleAdminTab(currentAdminTab); 
            } else { // student mode
                // í•™ìƒ ëª¨ë“œ í™œì„±í™”
                stopCamera();
                staffView.style.display = 'none';
                studentView.style.display = 'flex';
                
                // í•™ìƒ ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
                staffBtn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                studentBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');

                updateStudentModeUI();
            }
        }

        /**
         * ê´€ë¦¬ì ëª¨ë“œ ì„œë¸Œ íƒ­ ì „í™˜ ì²˜ë¦¬ ('scanner' or 'data')
         */
        window.toggleAdminTab = function(tabName) {
            currentAdminTab = tabName;
            const scannerTab = document.getElementById('scanner-tab');
            const dataTab = document.getElementById('data-tab');
            const scannerBtn = document.getElementById('scanner-tab-btn');
            const dataBtn = document.getElementById('data-tab-btn');

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            scannerBtn.classList.remove('bg-blue-600', 'text-white', 'bg-gray-100', 'text-gray-700');
            dataBtn.classList.remove('bg-blue-600', 'text-white', 'bg-gray-100', 'text-gray-700');

            if (tabName === 'scanner') {
                scannerTab.style.display = 'grid';
                dataTab.style.display = 'none';
                startScanner();
                
                scannerBtn.classList.add('bg-blue-600', 'text-white');
                dataBtn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-white');
            } else { // data tab
                scannerTab.style.display = 'none';
                dataTab.style.display = 'block';
                stopCamera();
                
                scannerBtn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-white');
                dataBtn.classList.add('bg-blue-600', 'text-white');
            }
        }

        /**
         * ëª¨ë“œ ì „í™˜ í•¨ìˆ˜ (ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬)
         */
        window.toggleMode = function(newMode) {
            if (newMode !== currentMode) {
                setupMode(newMode);
            }
        }
        
        // --- 3. Student Registration/Login (Student Mode) ---
        
        /**
         * í˜„ì¬ ì‚¬ìš©ì IDê°€ ë“±ë¡ëœ í•™ìƒì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
         */
        async function checkUserRegistrationStatus(id) {
            if (!db || !id) return;
            try {
                const userDocRef = doc(db, USERS_COLLECTION, id);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    isUserRegistered = true;
                    studentProfile = userDoc.data();
                    // ë“±ë¡ì€ í–ˆì§€ë§Œ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ìƒíƒœë¡œ ì‹œì‘
                    showLoginForm(); 
                } else {
                    isUserRegistered = false;
                    studentProfile = null;
                    showRegisterForm();
                }
                updateStudentModeUI();
            } catch (e) {
                console.error("Error checking user registration:", e);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì¼ë‹¨ ë“±ë¡ í¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                showRegisterForm();
            }
        }

        /**
         * í•™ìƒ ëª¨ë“œì˜ UIë¥¼ ë“±ë¡ ìƒíƒœì— ë”°ë¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateStudentModeUI() {
            if (currentMode !== 'student') return;
            
            const authArea = document.getElementById('student-auth-area');
            const qrArea = document.getElementById('student-qr-area');

            if (studentProfile && studentProfile.isLoggedIn) {
                // ë¡œê·¸ì¸ ì™„ë£Œ ìƒíƒœ
                authArea.style.display = 'none';
                qrArea.style.display = 'flex';
                
                document.getElementById('student-info-display').textContent = 
                    `${studentProfile.grade_class_number} ${studentProfile.name} ë‹˜`;
                
                displayStudentQrCode(userId); // í˜„ì¬ ì¸ì¦ëœ Firebase userIdë¥¼ QR ì½”ë“œ ë‚´ìš©ìœ¼ë¡œ ì‚¬ìš©
                document.getElementById('student-qr-data').textContent = userId.substring(0, 10) + '...';
                
            } else {
                // ë¯¸ë“±ë¡ ë˜ëŠ” ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                authArea.style.display = 'block';
                qrArea.style.display = 'none';
            }
        }

        /**
         * íšŒì›ê°€ì… í¼ í‘œì‹œ
         */
        window.showRegisterForm = function() {
            document.getElementById('register-form').style.display = 'block';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('student-view-title').textContent = 'í•™ìƒ ëª¨ë“œ - ë“±ë¡í•˜ê¸°';
            document.getElementById('login-status').style.display = 'none';
        }

        /**
         * ë¡œê·¸ì¸ í¼ í‘œì‹œ
         */
        window.showLoginForm = function() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('student-view-title').textContent = 'í•™ìƒ ëª¨ë“œ - ë¡œê·¸ì¸';
            document.getElementById('register-status').style.display = 'none';
        }

        /**
         * í•™ìƒ ë“±ë¡ (íšŒì›ê°€ì…) ì²˜ë¦¬
         */
        window.registerUser = async function() {
            if (!db || !userId) return;
            const name = document.getElementById('register-name').value.trim();
            const gradeClass = document.getElementById('register-grade-class').value.trim();
            const pin = document.getElementById('register-pin').value.trim();
            const statusMsg = document.getElementById('register-status');
            statusMsg.style.display = 'none';

            if (!name || !gradeClass || pin.length !== 4) {
                statusMsg.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš” (PIN 4ìë¦¬).';
                statusMsg.style.display = 'block';
                return;
            }
            
            // PINì„ ê°„ë‹¨í•˜ê²Œ í•´ì‹± (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë” ê°•ë ¥í•œ í•´ì‹± í•„ìš”)
            const pinHash = btoa(pin); 

            try {
                const userDocRef = doc(db, USERS_COLLECTION, userId);
                
                await setDoc(userDocRef, {
                    name: name,
                    grade_class_number: gradeClass,
                    pin_hash: pinHash, 
                    meal_status: false, // ê¸°ë³¸ê°’: ë¯¸ì‹ ì²­
                    isLoggedIn: true, // ë“±ë¡ í›„ ë°”ë¡œ ë¡œê·¸ì¸ ìƒíƒœë¡œ
                    lastUpdated: Timestamp.now()
                });

                isUserRegistered = true;
                studentProfile = { name, grade_class_number: gradeClass, pin_hash: pinHash, meal_status: false, isLoggedIn: true };
                statusMsg.textContent = 'âœ… ë“±ë¡ ì™„ë£Œ! QR ì½”ë“œê°€ í™œì„±í™”ë©ë‹ˆë‹¤.';
                statusMsg.classList.remove('text-red-600');
                statusMsg.classList.add('text-green-600');
                statusMsg.style.display = 'block';
                
                // ì„±ê³µ í›„ QR ì½”ë“œ í‘œì‹œ
                updateStudentModeUI(); 

            } catch (e) {
                console.error("Registration failed:", e);
                statusMsg.textContent = `âŒ ë“±ë¡ ì‹¤íŒ¨: ${e.message}`;
                statusMsg.classList.remove('text-green-600');
                statusMsg.classList.add('text-red-600');
                statusMsg.style.display = 'block';
            }
        }
        
        /**
         * í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬ (í•€ ë²ˆí˜¸ í™•ì¸)
         */
        window.loginUser = async function() {
            if (!db || !userId) return;
            const name = document.getElementById('login-name').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            const statusMsg = document.getElementById('login-status');
            statusMsg.style.display = 'none';

            if (!name || pin.length !== 4) {
                statusMsg.textContent = 'ì´ë¦„ê³¼ 4ìë¦¬ í•€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                statusMsg.style.display = 'block';
                return;
            }

            try {
                const userDocRef = doc(db, USERS_COLLECTION, userId);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    statusMsg.textContent = 'ë“±ë¡ëœ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë“±ë¡í•´ ì£¼ì„¸ìš”.';
                    statusMsg.style.display = 'block';
                    return;
                }
                
                const userData = userDoc.data();
                const pinHash = btoa(pin);
                
                if (userData.name === name && userData.pin_hash === pinHash) {
                    // ë¡œê·¸ì¸ ì„±ê³µ
                    
                    // Firestoreì— ë¡œê·¸ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì˜µì…˜)
                    await updateDoc(userDocRef, { isLoggedIn: true, lastLogin: Timestamp.now() });
                    
                    studentProfile = { ...userData, isLoggedIn: true };
                    statusMsg.textContent = 'âœ… ë¡œê·¸ì¸ ì„±ê³µ! QR ì½”ë“œê°€ í™œì„±í™”ë©ë‹ˆë‹¤.';
                    statusMsg.classList.remove('text-red-600');
                    statusMsg.classList.add('text-green-600');
                    statusMsg.style.display = 'block';
                    
                    updateStudentModeUI(); 
                } else {
                    statusMsg.textContent = 'ì´ë¦„ ë˜ëŠ” í•€ ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    statusMsg.classList.remove('text-green-600');
                    statusMsg.classList.add('text-red-600');
                    statusMsg.style.display = 'block';
                }

            } catch (e) {
                console.error("Login failed:", e);
                statusMsg.textContent = `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.message}`;
                statusMsg.classList.remove('text-green-600');
                statusMsg.classList.add('text-red-600');
                statusMsg.style.display = 'block';
            }
        }

        /**
         * í•™ìƒ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
         */
        window.logoutUser = async function() {
            if (!db || !userId || !studentProfile) return;
            
            try {
                const userDocRef = doc(db, USERS_COLLECTION, userId);
                await updateDoc(userDocRef, { isLoggedIn: false });
                
                studentProfile.isLoggedIn = false;
                alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateStudentModeUI();
                showLoginForm();

            } catch (e) {
                console.error("Logout failed:", e);
                alert(`ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
            }
        }

        /**
         * QR ì½”ë“œ í‘œì‹œ
         */
        function displayStudentQrCode(data) {
            if (!data) return;
            const qrContainer = document.getElementById('qrcode-display');
            
            // ê¸°ì¡´ QR ì½”ë“œ ì¸ìŠ¤í„´ìŠ¤ ì œê±°
            qrContainer.innerHTML = '';
            
            // ìƒˆë¡œìš´ QR ì½”ë“œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            qrCodeInstance = new QRCode(qrContainer, {
                text: data,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }
        
        // --- 4. Scanner Functions (Staff Mode) ---

        async function startScanner() {
            if (videoStream || currentMode !== 'staff' || currentAdminTab !== 'scanner') return;

            try {
                // ì¹´ë©”ë¼ í•´ìƒë„ ìµœì í™” 
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: { exact: "environment" },
                        width: { max: 1280 }, 
                        height: { max: 720 },
                        frameRate: { ideal: 20 } 
                    } 
                });
                
                video.srcObject = videoStream;
                video.setAttribute("playsinline", true); 
                video.play();
                
                video.onloadedmetadata = () => {
                    canvasElement.width = video.videoWidth;
                    canvasElement.height = video.videoHeight;
                    canvasElement.style.display = 'block';
                    document.getElementById('no-camera-msg').style.display = 'none';
                    document.getElementById('scan-ui-overlay').style.display = 'block';
                    
                    requestAnimationFrame(tick);
                };

            } catch (err) {
                console.error("Camera access error:", err);
                document.getElementById('no-camera-msg').style.display = 'flex';
                canvasElement.style.display = 'none';
                document.getElementById('scan-ui-overlay').style.display = 'none';
                alertMessage('ì¹´ë©”ë¼ ì˜¤ë¥˜', 'ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.', 'error');
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                video.srcObject = null;
                
                // ìº”ë²„ìŠ¤ í¬ê¸° ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
                canvasElement.width = 1;
                canvasElement.height = 1;
                canvasElement.style.display = 'none';
            }
        }

        function tick() {
            if (currentMode !== 'staff' || currentAdminTab !== 'scanner' || !videoStream) return; 
            
            if (video.readyState === video.HAVE_ENOUGH_DATA && !isProcessing) {
                const { videoWidth, videoHeight } = video;
                
                if (canvasElement.width !== videoWidth || canvasElement.height !== videoHeight) {
                    canvasElement.width = videoWidth;
                    canvasElement.height = videoHeight;
                }

                canvas.drawImage(video, 0, 0, videoWidth, videoHeight);
                let imageData = canvas.getImageData(0, 0, videoWidth, videoHeight);
                
                let code = jsQR(imageData.data, imageData.width, imageData.height); 

                if (code) {
                    drawBox(code.location, videoWidth, videoHeight);
                    if (!isProcessing) {
                        processQrCode(code.data);
                    }
                } else {
                    if (!isProcessing && lastScannedCode) {
                        lastScannedCode = null;
                    }
                }
            }
            
            if (!isProcessing) {
                requestAnimationFrame(tick);
            }
        }

        function drawBox(location, videoWidth, videoHeight) {
            canvas.beginPath();
            canvas.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
            canvas.lineTo(location.topRightCorner.x, location.topRightCorner.y);
            canvas.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
            canvas.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
            canvas.lineTo(location.topLeftCorner.x, location.topLeftCorner.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = isProcessing ? "#f59e0b" : "#10b981"; 
            canvas.stroke();
        }

        // --- 5. Core Check-in Logic ---

        async function processQrCode(scannedCode) {
            if (!db || isProcessing) return;
            
            // QR ì½”ë“œ ë‚´ìš©ì€ ì´ì œ í•™ìƒì˜ Firebase userIdì…ë‹ˆë‹¤.
            if (lastScannedCode === scannedCode) {
                return;
            }
            
            isProcessing = true;
            lastScannedCode = scannedCode;

            alertMessage('ì •ë³´ í™•ì¸ ì¤‘...', `ìŠ¤ìº”ëœ ID: ${scannedCode.substring(0, 8)}...`, 'waiting');

            try {
                // 1. í•™ìƒ (ì‚¬ìš©ì) IDë¡œ ë¬¸ì„œ ì¡°íšŒ
                const studentDocRef = doc(db, USERS_COLLECTION, scannedCode);
                const studentDoc = await getDoc(studentDocRef);

                if (!studentDoc.exists()) {
                    throw new Error(`[ì˜¤ë¥˜] ë“±ë¡ë˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤: ${scannedCode.substring(0, 10)}...`);
                }

                const studentData = studentDoc.data();
                const nameInfo = studentData.name || 'ì´ë¦„ ì—†ìŒ';
                const mealStatus = studentData.meal_status ? 'ì‹ ì²­í•¨' : 'ë¯¸ì‹ ì²­';
                const gradeInfo = studentData.grade_class_number || 'ì •ë³´ ì—†ìŒ';

                // 2. ì´ë¯¸ ì˜¤ëŠ˜ ì²´í¬ì¸í–ˆëŠ”ì§€ í™•ì¸
                const checkinRef = collection(db, CHECKINS_COLLECTION);
                const q = query(checkinRef, 
                    where("studentId", "==", scannedCode),
                    where("date", "==", TODAY_DATE)
                );
                const checkinDocs = await getDocs(q);

                if (!checkinDocs.empty) {
                    // ì´ë¯¸ ì²´í¬ì¸í•œ ê²½ìš°
                    alertMessage('âš ï¸ ì´ë¯¸ ì²´í¬ì¸ë¨', `${nameInfo} (${gradeInfo}) ë‹˜ì€ ì´ë¯¸ ì˜¤ëŠ˜(${TODAY_DATE}) ì²´í¬ì¸í–ˆìŠµë‹ˆë‹¤. ì„ì‹ ìƒíƒœ: ${mealStatus}`, 'error');
                    await addLogEntry(scannedCode, nameInfo, 'DUPLICATE', 'ì´ë¯¸ ì²´í¬ì¸ë¨');
                    
                } else {
                    // 3. ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ ì²´í¬ì¸ ê¸°ë¡ ë° í•™ìƒ ì •ë³´ ì—…ë°ì´íŠ¸
                    const batch = writeBatch(db);

                    // A. ì²´í¬ì¸ ê¸°ë¡ ì¶”ê°€
                    const newCheckinRef = doc(checkinRef);
                    batch.set(newCheckinRef, {
                        studentId: scannedCode,
                        name: nameInfo,
                        grade_class_number: gradeInfo,
                        meal_status: studentData.meal_status,
                        date: TODAY_DATE,
                        timestamp: Timestamp.now(),
                        checkedInBy: userId
                    });

                    // B. í•™ìƒ ì •ë³´ì— ìµœì¢… ì²´í¬ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸ (í˜„í™©íŒ ì—…ë°ì´íŠ¸ìš©)
                    batch.update(studentDocRef, {
                        lastCheckin: Timestamp.now()
                    });

                    await batch.commit();

                    // 4. ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    alertMessage('âœ… ì…ì¥ í™•ì¸ ì™„ë£Œ', `${nameInfo} (${gradeInfo}) ë‹˜, ì²´í¬ì¸ ì™„ë£Œ! ì„ì‹ ìƒíƒœ: ${mealStatus}`, 'success');
                    await addLogEntry(scannedCode, nameInfo, 'SUCCESS', 'ì²´í¬ì¸ ì™„ë£Œ');
                }
                
                // 3ì´ˆ í›„ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜ ë° isProcessing í•´ì œ
                setTimeout(() => {
                    isProcessing = false;
                    if (currentMode === 'staff' && currentAdminTab === 'scanner') {
                         alertMessage('ì²´í¬ì¸ ìŠ¤ìºë„ˆ ëŒ€ê¸° ì¤‘...', 'í•™ìƒì˜ QR ì½”ë“œë¥¼ ìŠ¤ìº” ì˜ì—­ì— ë¹„ì¶°ì£¼ì„¸ìš”.', 'waiting');
                         requestAnimationFrame(tick); // ì¬ê·€ í˜¸ì¶œ ì¬ê°œ
                    }
                }, 3000); 
                
            } catch (error) {
                console.error("Check-in Error:", error.message);
                alertMessage('âŒ ì²˜ë¦¬ ì˜¤ë¥˜', `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');

                await addLogEntry(scannedCode, 'ì•Œ ìˆ˜ ì—†ìŒ', 'ERROR', error.message);
                
                // ì˜¤ë¥˜/ì‹¤íŒ¨ ì‹œì—ëŠ” 1ì´ˆ í›„ ì¬ì‹œë„ ê°€ëŠ¥
                setTimeout(() => {
                    isProcessing = false;
                    lastScannedCode = null; // ì‹¤íŒ¨í–ˆìœ¼ë¯€ë¡œ ì½”ë“œ ì´ˆê¸°í™”
                    if (currentMode === 'staff' && currentAdminTab === 'scanner') {
                        alertMessage('ì²´í¬ì¸ ìŠ¤ìºë„ˆ ëŒ€ê¸° ì¤‘...', 'í•™ìƒì˜ QR ì½”ë“œë¥¼ ìŠ¤ìº” ì˜ì—­ì— ë¹„ì¶°ì£¼ì„¸ìš”.', 'waiting');
                        requestAnimationFrame(tick); // ì¬ê·€ í˜¸ì¶œ ì¬ê°œ
                    }
                }, 1000); // 1ì´ˆ í›„ ì¬ì‹œë„ ê°€ëŠ¥í•˜ë„ë¡ isProcessing í•´ì œ
            }
        }
        
        // --- 6. Data Management Functions (Data Tab - Admin) ---

        /**
         * ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ììš©)
         */
        window.toggleMealStatus = async function(studentId, currentStatus) {
            if (!db) return;
            const newStatus = !currentStatus;
            
            try {
                const userDocRef = doc(db, USERS_COLLECTION, studentId);
                await updateDoc(userDocRef, {
                    meal_status: newStatus,
                    lastUpdated: Timestamp.now()
                });
                alert(`âœ… ${studentDataCache[studentId].name} ë‹˜ì˜ ì„ì‹ ìƒíƒœê°€ "${newStatus ? 'ì‹ ì²­ë¨' : 'ë¯¸ì‹ ì²­'}"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (e) {
                console.error("Meal status update failed:", e);
                alert(`âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${e.message}`);
            }
        }


        /**
         * ì˜¤ëŠ˜ ì²´í¬ì¸ ìƒíƒœ ëª¨ë‘ ì´ˆê¸°í™” (ì˜¤ëŠ˜ì ì²´í¬ì¸ ë¬¸ì„œ ì „ì²´ ì‚­ì œ)
         */
        window.resetTodayCheckins = async function() {
            if (!db) return;
            
            if (!window.confirm("ì˜¤ëŠ˜ ê¸°ë¡ëœ ëª¨ë“  ì²´í¬ì¸ ê¸°ë¡ì„ ì‚­ì œí•˜ê³  ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) {
                return;
            }

            try {
                const checkinRef = collection(db, CHECKINS_COLLECTION);
                const q = query(checkinRef, where("date", "==", TODAY_DATE));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    alert('ì˜¤ëŠ˜ ì‚­ì œí•  ì²´í¬ì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                alert('âœ… ì˜¤ëŠ˜ ì²´í¬ì¸ ê¸°ë¡ ' + snapshot.size + 'ê±´ì´ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await addLogEntry('SYSTEM', 'ê´€ë¦¬ì', 'RESET', `ì˜¤ëŠ˜ì ì²´í¬ì¸ ê¸°ë¡ ${snapshot.size}ê±´ ì´ˆê¸°í™”`);

            } catch (e) {
                console.error("Reset failed:", e);
                alert('âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        }


        // --- 7. Real-time Status Table Functions (Shared) ---
        
        /**
         * í•™ìƒ í˜„í™© ë° ì˜¤ëŠ˜ ì²´í¬ì¸ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
         */
        function setupStudentStatusListener() {
            if (!db) return;

            // 1. í•™ìƒ ì „ì²´ ëª©ë¡ ë¦¬ìŠ¤ë„ˆ (USERS_COLLECTION)
            onSnapshot(collection(db, USERS_COLLECTION), (snapshot) => {
                studentDataCache = {};
                snapshot.forEach(doc => {
                    studentDataCache[doc.id] = { ...doc.data(), code: doc.id };
                });
                renderStudentStatusTable();
            }, (error) => {
                console.error("User List Listener Error:", error);
            });

            // 2. ì˜¤ëŠ˜ ì²´í¬ì¸ ê¸°ë¡ ë¦¬ìŠ¤ë„ˆ
            const checkinRef = collection(db, CHECKINS_COLLECTION);
            const q = query(checkinRef, where("date", "==", TODAY_DATE));
            
            onSnapshot(q, (snapshot) => {
                checkinDataCache = {};
                snapshot.forEach(doc => {
                    // í‚¤ëŠ” í•™ìƒ ID (userId)ë¡œ ì €ì¥
                    checkinDataCache[doc.data().studentId] = true; 
                });
                renderStudentStatusTable();
            }, (error) => {
                console.error("Check-in List Listener Error:", error);
            });
        }
        
        /**
         * ìºì‹œëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜„í™©íŒ UI ë° ê´€ë¦¬ì íƒ­ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function renderStudentStatusTable() {
            const tbody = document.getElementById('student-status-body');
            const dataTabContent = document.getElementById('data-tab');

            tbody.innerHTML = '';
            
            const students = Object.values(studentDataCache).filter(s => s.name); // ì´ë¦„ì´ ìˆëŠ” ë“±ë¡ëœ í•™ìƒë§Œ í‘œì‹œ
            
            // ì´ë¦„ ìˆœìœ¼ë¡œ ì •ë ¬ 
            students.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            if (students.length === 0) {
                tbody.innerHTML = '<tr class="bg-white border-b"><td class="py-4 px-6 text-center" colspan="5">ë“±ë¡ëœ í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                // ê´€ë¦¬ì ë°ì´í„° íƒ­ì—ë„ ë©”ì‹œì§€ í‘œì‹œ
                if (currentAdminTab === 'data') {
                     dataTabContent.innerHTML = '<div class="p-6 text-center text-gray-500">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. í•™ìƒë“¤ì´ í•™ìƒ ëª¨ë“œì—ì„œ ë“±ë¡í•´ì•¼ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>';
                }
                return;
            }

            // ------------------ í˜„í™©íŒ í…Œì´ë¸” ë Œë”ë§ ------------------
            students.forEach(student => {
                const isCheckedIn = checkinDataCache[student.code] === true;

                // ì„ì‹ ìƒíƒœ íƒœê·¸
                const mealStatusText = student.meal_status ? 'ì‹ ì²­í•¨' : 'ë¯¸ì‹ ì²­';
                const mealStatusClass = student.meal_status ? 'meal-status-paid' : 'meal-status-unpaid';

                // ì²´í¬ì¸ ìƒíƒœ íƒœê·¸
                const checkinStatusText = isCheckedIn ? 'ì²´í¬ì¸ ì™„ë£Œ' : 'ëŒ€ê¸° ì¤‘';
                const checkinStatusClass = isCheckedIn ? 'checkin-status-complete' : 'checkin-status-waiting';

                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${student.name || 'ì´ë¦„ ì—†ìŒ'}</td>
                        <td class="py-4 px-6">${student.grade_class_number || 'ì •ë³´ ì—†ìŒ'}</td>
                        <td class="py-4 px-6">
                            <span class="meal-status-tag ${mealStatusClass}">${mealStatusText}</span>
                        </td>
                        <td class="py-4 px-6">
                            <span class="meal-status-tag ${checkinStatusClass}">${checkinStatusText}</span>
                        </td>
                        <td class="py-4 px-6 font-mono text-xs">${student.code.substring(0, 8)}...</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            
            // ------------------ ê´€ë¦¬ì ë°ì´í„° íƒ­ ë Œë”ë§ ------------------
            if (currentAdminTab === 'data') {
                let dataTableHtml = `
                    <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-6">ì´ë¦„</th>
                                    <th scope="col" class="py-3 px-6">í•™ë²ˆ</th>
                                    <th scope="col" class="py-3 px-6">QR ì½”ë“œ ID</th>
                                    <th scope="col" class="py-3 px-6">ì„ì‹ ê²°ì œ ìƒíƒœ</th>
                                    <th scope="col" class="py-3 px-6">ìƒíƒœ ë³€ê²½</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                students.forEach(student => {
                    const statusText = student.meal_status ? 'ì‹ ì²­ë¨' : 'ë¯¸ì‹ ì²­';
                    const buttonText = student.meal_status ? 'ë¯¸ì‹ ì²­ìœ¼ë¡œ ë³€ê²½' : 'ì‹ ì²­ë¨ìœ¼ë¡œ ë³€ê²½';
                    const buttonClass = student.meal_status ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
                    
                    dataTableHtml += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${student.name || 'ì´ë¦„ ì—†ìŒ'}</td>
                            <td class="py-4 px-6">${student.grade_class_number || 'ì •ë³´ ì—†ìŒ'}</td>
                            <td class="py-4 px-6 font-mono text-xs">${student.code.substring(0, 8)}...</td>
                            <td class="py-4 px-6 font-bold text-center ${student.meal_status ? 'text-green-600' : 'text-yellow-600'}">${statusText}</td>
                            <td class="py-4 px-6">
                                <button onclick="toggleMealStatus('${student.code}', ${student.meal_status})" 
                                        class="text-white text-xs font-bold py-1 px-3 rounded-full transition-colors ${buttonClass}">
                                    ${buttonText}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                dataTableHtml += '</tbody></table></div>';
                
                // ê¸°ì¡´ ë‚´ìš©ì„ ë®ì–´ì“°ê¸° ì „ì— í•„ìš”í•œ ì œëª©ê³¼ ë©”ì‹œì§€ë¥¼ ìœ ì§€
                 dataTabContent.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">í•™ìƒ ì •ë³´ ê´€ë¦¬ (ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸)</h3>
                        <p class="text-gray-600 text-sm mb-4">
                            í•™ìƒì´ ë“±ë¡(íšŒì›ê°€ì…)ì„ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì— ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤. ê²°ì œ ìƒíƒœë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                    ${dataTableHtml}
                `;
            }
        }


        // --- 8. Logging Functions ---
        
        async function addLogEntry(studentId, name, type, message) {
            const logCollection = collection(db, LOGS_COLLECTION);
            try {
                await addDoc(logCollection, {
                    timestamp: Timestamp.now(),
                    studentId: studentId,
                    name: name,
                    type: type, // SUCCESS, DUPLICATE, ERROR, RESET
                    message: message,
                    scannedBy: userId,
                });
            } catch (error) {
                console.error("Failed to write log entry:", error);
            }
        }

        function setupLogListener() {
            const logCollection = collection(db, LOGS_COLLECTION);
            const q = query(logCollection); 
            
            onSnapshot(q, (snapshot) => {
                const logList = document.getElementById('log-list');
                logList.innerHTML = '';
                
                const logs = [];
                snapshot.forEach(doc => logs.push(doc.data()));
                
                logs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                
                logs.slice(0, 8).forEach(log => {
                    const li = document.createElement('li');
                    li.className = 'p-2 rounded';
                    
                    const time = log.timestamp ? new Date(log.timestamp.toMillis()).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'ì‹œê°„ ì•Œ ìˆ˜ ì—†ìŒ';
                    let statusClass = '';
                    let statusIcon = '';

                    if (log.type === 'SUCCESS') {
                        statusClass = 'bg-green-100 text-green-800';
                        statusIcon = 'âœ…';
                    } else if (log.type === 'DUPLICATE' || log.type === 'ERROR') {
                        statusClass = 'bg-red-100 text-red-800';
                        statusIcon = 'âŒ';
                    } else if (log.type === 'RESET') {
                        statusClass = 'bg-purple-100 text-purple-800';
                        statusIcon = 'ğŸ”„';
                    } else {
                        statusClass = 'bg-gray-100 text-gray-800';
                        statusIcon = 'â„¹ï¸';
                    }
                    
                    li.classList.add(statusClass);
                    const nameDisplay = log.name && log.name !== 'ì•Œ ìˆ˜ ì—†ìŒ' ? log.name : 'ë¯¸ë“±ë¡ ì‚¬ìš©ì';
                    const idDisplay = log.studentId && log.studentId !== 'SYSTEM' ? log.studentId.substring(0, 4) + '...' : log.studentId;

                    li.innerHTML = `<span class="font-bold mr-1">${statusIcon} ${time}</span> ${nameDisplay} (${idDisplay}) - ${log.message}`;
                    logList.appendChild(li);
                });

                if (logs.length === 0) {
                    logList.innerHTML = '<li class="p-2 bg-gray-50 rounded">ì•„ì§ ê¸°ë¡ëœ ìŠ¤ìº”ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                }
            }, (error) => {
                console.error("Log Listener Error:", error);
            });
        }
        
        // --- 9. Initial Call ---
        // Auth listenerê°€ ëª¨ë“  ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.

    </script>
</body>
</html>